<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecule Merge</title>
    <!-- Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for game elements not covered by Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        .molecule-grid-cell {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: white;
            transition: transform 0.2s ease-out, background-color 0.2s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const { createRoot } = ReactDOM;

        // Define a simplified periodic table for merging
        const MOLECULES = {
            'H': { label: 'H', color: 'bg-gray-400', next: 'He', name: 'Hydrogen' },
            'He': { label: 'He', color: 'bg-blue-400', next: 'Li', name: 'Helium' },
            'Li': { label: 'Li', color: 'bg-yellow-400', next: 'Be', name: 'Lithium' },
            'Be': { label: 'Be', color: 'bg-green-400', next: 'B', name: 'Beryllium' },
            'B': { label: 'B', color: 'bg-orange-400', next: 'C', name: 'Boron' },
            'C': { label: 'C', color: 'bg-red-400', next: 'N', name: 'Carbon' },
            'N': { label: 'N', color: 'bg-purple-400', next: 'O', name: 'Nitrogen' },
            'O': { label: 'O', color: 'bg-pink-400', next: 'F', name: 'Oxygen' },
            'F': { label: 'F', color: 'bg-cyan-400', next: null, name: 'Fluorine' }
        };

        const GRID_WIDTH = 6;
        const GRID_HEIGHT = 8;
        const FREE_PLAY_DROP_INTERVAL = 1500;
        const LEVEL_PLAY_BASE_DROP_INTERVAL = 1000;

        const getNewMolecule = () => {
            const keys = Object.keys(MOLECULES);
            const molecule = keys[0]; // Start with Hydrogen
            return molecule;
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('home');
            const [gameMode, setGameMode] = useState('freeplay');
            const [grid, setGrid] = useState([]);
            const [currentMolecule, setCurrentMolecule] = useState(null);
            const [nextMolecule, setNextMolecule] = useState(getNewMolecule());
            const [score, setScore] = useState(0);
            const [level, setLevel] = useState(1);
            const [targetMolecule, setTargetMolecule] = useState('O');
            const [isGameOver, setIsGameOver] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [modalConfirmAction, setModalConfirmAction] = useState(null);
            const [showSuccessModal, setShowSuccessModal] = useState(false);
            const intervalRef = useRef(null);

            const initializeGrid = useCallback(() => {
                const newGrid = Array.from({ length: GRID_HEIGHT }, () => Array(GRID_WIDTH).fill(null));
                setGrid(newGrid);
                setIsGameOver(false);
                setScore(0);
                setLevel(1);
                setCurrentMolecule(null);
                setNextMolecule(getNewMolecule());
            }, []);

            const checkMerge = useCallback((y, x, newGrid) => {
                const molecule = newGrid[y][x];
                if (!molecule) return false;

                const checkAndMerge = (y1, x1, y2, x2) => {
                    if (y1 >= 0 && y1 < GRID_HEIGHT && x1 >= 0 && x1 < GRID_WIDTH &&
                        y2 >= 0 && y2 < GRID_HEIGHT && x2 >= 0 && x2 < GRID_WIDTH &&
                        newGrid[y1][x1] === molecule && newGrid[y2][x2] === molecule) {
                        const nextMolecule = MOLECULES[molecule].next;
                        if (nextMolecule) {
                            newGrid[y1][x1] = null;
                            newGrid[y2][x2] = null;
                            newGrid[y][x] = nextMolecule;
                            setScore(prev => prev + 50 * level);
                            return true;
                        }
                    }
                    return false;
                };

                let merged = false;
                // Check horizontal merge
                if (checkAndMerge(y, x, y, x + 1) || checkAndMerge(y, x, y, x - 1)) merged = true;
                // Check vertical merge
                if (checkAndMerge(y, x, y + 1, x) || checkAndMerge(y, x, y - 1, x)) merged = true;
                return merged;
            }, [level]);

            const findLowestSpot = useCallback((x, molecule) => {
                let y = 0;
                while (y < GRID_HEIGHT - 1 && grid[y + 1][x] === null) {
                    y++;
                }
                return y;
            }, [grid]);

            const placeMolecule = useCallback((x) => {
                const y = findLowestSpot(x, currentMolecule);
                const newGrid = grid.map(row => [...row]);
                
                if (newGrid[y][x] !== null) {
                    setIsGameOver(true);
                    return;
                }
                
                newGrid[y][x] = currentMolecule;

                // Propagate merges
                let merged = true;
                while (merged) {
                    merged = false;
                    for (let row = GRID_HEIGHT - 1; row >= 0; row--) {
                        for (let col = 0; col < GRID_WIDTH; col++) {
                            if (checkMerge(row, col, newGrid)) {
                                merged = true;
                            }
                        }
                    }
                }
                
                // Check for level completion
                if (gameMode === 'levelplay') {
                    const hasTarget = newGrid.flat().some(cell => cell === targetMolecule);
                    if (hasTarget) {
                        setShowSuccessModal(true);
                        setLevel(prev => prev + 1);
                        setTargetMolecule(MOLECULES[targetMolecule].next || targetMolecule);
                    }
                }

                setGrid(newGrid);
                setCurrentMolecule(null);
                setNextMolecule(getNewMolecule());
            }, [currentMolecule, grid, findLowestSpot, checkMerge, gameMode, targetMolecule]);

            const handleKeyDown = useCallback((e) => {
                if (isGameOver || currentView !== 'game') return;

                const dropColumn = parseInt(e.key, 10) - 1;
                if (!isNaN(dropColumn) && dropColumn >= 0 && dropColumn < GRID_WIDTH) {
                    if (currentMolecule) {
                        placeMolecule(dropColumn);
                    }
                }
            }, [isGameOver, currentView, currentMolecule, placeMolecule]);

            const handleClickDrop = useCallback((x) => {
                if (isGameOver || currentView !== 'game' || !currentMolecule) return;
                placeMolecule(x);
            }, [isGameOver, currentView, currentMolecule, placeMolecule]);

            useEffect(() => {
                if (isGameOver || currentView !== 'game') {
                    if (intervalRef.current) clearInterval(intervalRef.current);
                    return;
                }
                if (!currentMolecule) {
                    setCurrentMolecule(nextMolecule);
                }
            }, [currentMolecule, nextMolecule, isGameOver, currentView]);

            // Event listener for keyboard
            useEffect(() => {
                window.addEventListener('keydown', handleKeyDown);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                };
            }, [handleKeyDown]);

            const handleModeSwitch = (mode) => {
                if (score > 0) {
                    setModalMessage(`Your current progress will be lost. Are you sure you want to switch to ${mode} mode?`);
                    setModalConfirmAction(() => () => {
                        setGameMode(mode);
                        setCurrentView('game');
                        setIsModalOpen(false);
                        initializeGrid();
                    });
                    setIsModalOpen(true);
                } else {
                    setGameMode(mode);
                    setCurrentView('game');
                    initializeGrid();
                }
            };

            const renderGrid = () => (
                <div className="flex flex-col items-center">
                    <div className="grid grid-cols-6 gap-1 p-2 bg-gray-900 rounded-lg shadow-xl mb-4 border-4 border-gray-800">
                        {Array.from({ length: GRID_WIDTH }).map((_, x) => (
                            <button
                                key={`drop-${x}`}
                                onClick={() => handleClickDrop(x)}
                                className="w-12 h-8 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition-colors"
                            >
                                <i className="fas fa-arrow-down"></i>
                            </button>
                        ))}
                    </div>
                    <div className="grid border-4 border-gray-800 rounded-lg overflow-hidden bg-gray-900 shadow-xl"
                        style={{ gridTemplateColumns: `repeat(${GRID_WIDTH}, 1fr)` }}>
                        {grid.flat().map((molecule, index) => (
                            <div
                                key={index}
                                className={`molecule-grid-cell ${molecule ? MOLECULES[molecule].color : 'bg-transparent'}`}
                            >
                                {molecule ? MOLECULES[molecule].label : ''}
                            </div>
                        ))}
                    </div>
                    {isGameOver && (
                        <div className="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center rounded-lg text-white text-center p-4">
                            <h2 className="text-5xl font-bold mb-4">Game Over!</h2>
                            <p className="text-2xl mb-6">Final Score: {score}</p>
                            <button
                                onClick={() => initializeGrid()}
                                className="px-6 py-3 bg-red-600 text-white font-bold rounded-full transition-transform transform hover:scale-105 shadow-lg"
                            >
                                Play Again
                            </button>
                        </div>
                    )}
                </div>
            );

            const renderHomePage = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100 font-sans">
                    <h1 className="text-5xl font-bold mb-6 text-gray-800 drop-shadow-lg">Molecule Merge</h1>
                    <div className="w-full max-w-xl p-8 bg-white rounded-lg shadow-xl border-2 border-gray-200 text-center">
                        <h2 className="text-3xl font-bold mb-4 text-gray-700">How to Play</h2>
                        <ul className="list-disc list-inside text-left text-gray-600 space-y-2 mb-8">
                            <li>Click the **down arrow** buttons or use keyboard keys **1-6** to drop molecules into the column of your choice.</li>
                            <li>When two identical molecules touch, they will merge into the next one on the periodic table.</li>
                            <li>The game ends if a column overflows.</li>
                            <li>In **Level Mode**, you must create the target molecule to advance. The speed of merges may increase with each level.</li>
                            <li>In **Free Play**, the game continues indefinitely.</li>
                        </ul>
                        <div className="flex justify-center space-x-4">
                            <button
                                onClick={() => handleModeSwitch('freeplay')}
                                className="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-indigo-600 text-white shadow-lg hover:bg-indigo-700"
                            >
                                Start Free Play
                            </button>
                            <button
                                onClick={() => handleModeSwitch('levelplay')}
                                className="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-emerald-600 text-white shadow-lg hover:bg-emerald-700"
                            >
                                Start Level Play
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderGameView = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100 font-sans">
                    <h1 className="text-4xl font-bold mb-6 text-gray-800 drop-shadow-lg">Molecule Merge</h1>
                    <div className="flex space-x-4 mb-8">
                        <button
                            onClick={() => handleModeSwitch('freeplay')}
                            className={`px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 ${gameMode === 'freeplay' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-indigo-300 text-indigo-800 hover:bg-indigo-400'}`}
                        >
                            Free Play
                        </button>
                        <button
                            onClick={() => handleModeSwitch('levelplay')}
                            className={`px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 ${gameMode === 'levelplay' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-emerald-300 text-emerald-800 hover:bg-emerald-400'}`}
                        >
                            Level Play
                        </button>
                        <button
                            onClick={() => setCurrentView('home')}
                            className="px-6 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105 bg-gray-400 text-gray-800 hover:bg-gray-500"
                        >
                            Home
                        </button>
                    </div>

                    <div className="flex items-start space-x-8">
                        <div className="relative">
                            {renderGrid()}
                        </div>
                        <div className="w-56 p-6 bg-white rounded-lg shadow-lg border-2 border-gray-200">
                            <div className="text-xl font-bold text-center text-gray-700 mb-4">Game Stats</div>
                            <div className="space-y-3">
                                <p className="flex justify-between text-lg">
                                    <span className="font-semibold text-gray-600">Score:</span>
                                    <span className="font-bold text-gray-800">{score}</span>
                                </p>
                                {gameMode === 'levelplay' && (
                                    <>
                                        <p className="flex justify-between text-lg">
                                            <span className="font-semibold text-gray-600">Level:</span>
                                            <span className="font-bold text-gray-800">{level}</span>
                                        </p>
                                        <p className="flex justify-between text-lg">
                                            <span className="font-semibold text-gray-600">Target:</span>
                                            <span className={`font-bold text-gray-800 ${MOLECULES[targetMolecule].color} px-2 rounded`}>{MOLECULES[targetMolecule].label}</span>
                                        </p>
                                    </>
                                )}
                            </div>
                            <div className="mt-6">
                                <h3 className="text-xl font-bold text-center text-gray-700 mb-3">Next Element</h3>
                                <div className="p-2 border border-gray-300 rounded-md bg-gray-100 flex items-center justify-center">
                                    {nextMolecule && (
                                        <div
                                            className={`w-12 h-12 rounded-lg flex items-center justify-center text-lg font-bold text-white ${MOLECULES[nextMolecule].color}`}
                                        >
                                            {MOLECULES[nextMolecule].label}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800">Confirm Action</h3>
                                <p className="text-lg text-gray-600 mb-6">{modalMessage}</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={modalConfirmAction}
                                        className="px-6 py-3 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition-colors shadow"
                                    >
                                        Yes
                                    </button>
                                    <button
                                        onClick={() => setIsModalOpen(false)}
                                        className="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-full hover:bg-gray-400 transition-colors shadow"
                                    >
                                        No
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showSuccessModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm">
                                <h3 className="text-3xl font-bold mb-4 text-green-600">Level Complete! 🎉</h3>
                                <p className="text-lg text-gray-600 mb-6">
                                    You successfully created {MOLECULES[targetMolecule].name}! You are now on Level {level + 1}.
                                </p>
                                <button
                                    onClick={() => setShowSuccessModal(false)}
                                    className="px-6 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors shadow"
                                >
                                    Continue
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <>
                    {currentView === 'home' && renderHomePage()}
                    {currentView === 'game' && renderGameView()}
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
